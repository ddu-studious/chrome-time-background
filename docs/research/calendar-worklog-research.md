# 日历面板（按日期回看完成工作）调研

> 创建时间：2026-01-31  
> 目标：在侧边栏工具栏（按钮区域）新增“日历”能力：点击打开日历面板；点击任意日期，展示该日完成的任务/工作记录，并探索可扩展的高能辅助能力。

## 1. 现状与上下文（基于当前代码）

### 1.1 UI 结构

- 侧边栏工具栏由 `js/memo.js` 的 `renderSidebarContent()` 生成，现有按钮：
  - 新增任务 `#sidebar-add-btn`
  - 番茄钟 `#sidebar-pomodoro-btn`
  - 统计分析 `#sidebar-stats-btn`（已实现模态面板 `stats-panel`）
  - 管理分类 `#sidebar-settings-btn`

> 现有“统计分析”已采用 **点击按钮 → 生成/复用 DOM → 模态面板展示 → 绑定关闭事件** 的方式实现（样式在 `css/style.css` 中的 `.stats-panel`）。  
> 日历功能适合沿用相同模式（更统一、成本更低）。

### 1.2 数据结构与可用字段

项目备忘录（任务）对象结构中已出现 `completedAt` 字段（见 `js/memo.js` 的迁移/默认字段补齐逻辑），但当前“切换完成状态”的实现仅更新：

- `task.completed = !task.completed`
- `task.updatedAt = Date.now()`

并**未写入 `completedAt`**（当前代码中几乎没有对 `completedAt` 的赋值）。  
因此，要实现“按日期展示当天完成的工作”，需要补齐：**任务被标记完成时记录 `completedAt` 时间戳**；取消完成时清空（或按策略保留）。

## 2. 需求核心拆解

### 2.1 “当天完成的工作”口径

存在两个常见口径：

1. **按完成日**：以 `completedAt` 的日期为准（更符合“我这天做了什么”）。
2. **按截止日/计划日**：以 `dueDate`（YYYY-MM-DD）为准，展示“这天计划完成的工作里我完成了哪些”。

建议优先采用 **按完成日**（1），并在后续能力扩展中引入“按计划日”的切换（这会带来更强的复盘价值：计划 vs 实际）。

### 2.2 交互拆解

- 点击工具栏“日历”按钮 → 打开日历面板（模态层）
- 日历面板：
  - 月视图（7 列网格）
  - 月份切换（上月/下月）
  - “今天”快捷回跳（可选）
  - 日期格子状态：
    - 有完成任务：高亮 + 角标/徽标显示完成数
    - 无完成任务：普通
  - 点击日期 → 右侧/下方展示该日“完成列表”
    - 支持点击条目跳转到任务编辑（复用现有任务编辑弹窗/逻辑）

## 3. 方案调研：自研 vs 引入库

### 3.1 方案 A：自研轻量月视图（日历渲染 + 事件）

**做法**

- 复用统计面板的模态模式：新增 `calendar-panel`（类似 `stats-panel`）
- 用原生 JS 生成：
  - 面板头部：标题、月份切换、关闭
  - 日历网格：按当月第一天星期 + 天数填充
  - 日期格子可承载自定义 badge（完成数）
- 数据端：
  - 遍历 memos，筛选 `completed === true && completedAt`，以本地日期 \(YYYY-MM-DD\) 分桶为 Map

**优点**

- 体积最小、无依赖；符合当前项目“纯 CSS/纯 JS”风格
- 日历格子可完全自定义（完成数、颜色、心情/能量标记等）
- 更容易做到“任务详情面板”与现有 UI 统一

**缺点**

- 需要自行处理：月份切换、周起始、国际化、可访问性（但对本项目来说可渐进优化）

**适用性结论**

- 本项目已有统计面板/番茄钟等自绘面板经验，推荐优先选用此方案作为 v1。

### 3.2 方案 B：引入 Vanilla Calendar Pro（Context7 调研）

调研来源：Context7（库：`/uvarov-frontend/vanilla-calendar-pro`）

- 提供较完整的配置项与事件：
  - `onClickDate`（点击日期回调）
  - `onCreateDateEls`（创建日期元素时可定制）
  - 支持自定义布局 `layouts.default`，可拼装头部/周标题/日期区等

示例（官方文档展示了可通过 layouts 自定义结构）：

```javascript
new Calendar('#calendar', {
  layouts: {
    default: `
      <div class="vc-header" data-vc="header">
        <#ArrowPrev [month] />
        <div class="vc-header__content" data-vc-header="content">
          <#Month />
          <#Year />
        </div>
        <#ArrowNext [month] />
      </div>
      <div class="vc-wrapper" data-vc="wrapper">
        <div class="vc-content" data-vc="content">
          <#Week />
          <#Dates />
        </div>
      </div>
    `
  },
  onClickDate: (self, event) => {},
  onCreateDateEls: (self) => {}
});
```

**优点**

- 现成的月历、导航、选择模式、可访问性与大量配置项
- 可通过回调/布局定制外观与行为（理论上可加 marker/badge）

**风险/成本**

- 引入第三方库与样式，需考虑：
  - Chrome 扩展 CSP 与外部资源策略（建议本地打包而非 CDN）
  - 与现有磨砂玻璃 UI 风格的融合成本
  - 未来维护/升级成本

**适用性结论**

- 若后续需要复杂日历能力（范围选择、多月并排、键盘/无障碍强化等），可作为 v2 备选；v1 更建议自研以保持轻量与一致性。

### 3.3 方案 C：Flatpickr（Context7 调研结论）

Context7（库：`/flatpickr/flatpickr`）可用示例较少（片段覆盖不足），且该库更偏“日期选择器”而非“高定制日历面板”。  
因此不作为本需求的首选方案。

## 4. 可扩展的“高能辅助”能力（头脑风暴方向）

日历不仅是“选日期”，更适合作为“复盘与节奏管理”的入口。基于现有任务数据，可逐步丰富：

- **完成热力图（GitHub-like）**：按天完成数/完成时长渲染颜色深浅，快速感知节奏
- **连续完成天数（streak）**：强化习惯与动力反馈（已完成日历天然承载）
- **计划 vs 实际**：按 `dueDate`（计划日）与 `completedAt`（实际完成日）做对比，定位拖延模式
- **日复盘模板**：点击某天后，自动生成当日“完成清单 + 未完成清单 + 明日三件事”
- **周/月回顾**：按周聚合（完成数、完成率、过期率、分类分布），并生成简报
- **高峰时段洞察**：记录完成时间分布（上午/下午/晚上），形成个性化建议
- **导出/分享**：一键导出周报/月报（Markdown/图片）

## 5. v1 推荐落地策略（供需求文档使用）

1. **优先自研日历面板**（方案 A），沿用统计面板的模态实现与视觉语言。
2. **补齐数据**：完成状态切换时写入 `completedAt`（完成时写入 `Date.now()`；取消完成时置空），以完成日为口径展示。
3. **面板内容**：
   - 左侧：月视图 + 完成数 badge
   - 右侧：选中日期的完成列表（支持点击跳转编辑）
4. **后续演进**：
   - 热力图/streak/周报等作为二期能力，尽量复用同一数据聚合层（date → tasks）。

