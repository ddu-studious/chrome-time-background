# v1.7.0 日历面板：按日期回看完成工作

> 文档创建时间：2026-01-31  
> 关联调研：`docs/research/calendar-worklog-research.md`

## 1. 背景与目标

当前任务侧边栏已经提供“统计分析”等全局面板能力，但缺少一个**按时间维度**回看“我每天完成了什么”的入口。  
新增“日历面板”后，用户可以用**月视图**快速定位某天并查看当天完成的任务清单，作为日复盘/周回顾的基础能力。

## 2. 用户故事（User Stories）

- 作为用户，我希望在任务侧边栏工具栏点击一个按钮即可打开日历。
- 作为用户，我希望在日历上直观看到哪些日期完成了任务（最好能看到数量）。
- 作为用户，我希望点击某一天后，看到当天完成的任务列表（标题/摘要/完成时间）。
- 作为用户，我希望从列表里能快速跳转到某个任务的编辑界面（必要时修正内容）。

## 3. 范围（Scope）

### 3.1 v1 必做

- **入口**：侧边栏工具栏新增“日历”按钮（与统计/番茄钟同级）
- **面板**：模态面板（UI/交互风格对齐 `stats-panel`）
- **月视图**：
  - 上一月 / 下一月
  - 显示星期标题（周一~周日或周日~周六，v1 先固定一种）
  - 每个日期格子显示“日号”
  - 对“当天有完成任务”的日期显示徽标（badge：完成数）
- **日期详情**：
  - 点击某日期 → 展示该日完成任务列表
  - 空状态：提示“当天未完成任务”
- **数据补齐**：
  - 当任务从未完成切换为已完成时写入 `completedAt = Date.now()`
  - 当任务从已完成切换为未完成时清空 `completedAt = null`

### 3.2 v1 可选（有余力再做）

- “今天”快捷按钮（回到本月并选中今天）
- 日历面板内切换视角：
  - “按完成日”（默认）
  - “按计划日（dueDate）”

### 3.3 明确不做（Non-goals）

- 不做多月并排/范围选择/复杂日程（事件拖拽等）
- 不引入重量级日历库（保持轻量与一致风格）
- 不做云同步/导出（后续迭代）

## 4. 交互与视觉规范

### 4.1 入口位置与图标

- 位置：`renderSidebarContent()` 生成的 `.sidebar-toolbar`
- 按钮形态：沿用 `.sidebar-tool-btn`
- 图标建议：`fa-calendar-days`（如不可用则用 `fa-calendar`）
- `title`：`日历 / 回看完成`

### 4.2 面板布局（建议）

- 顶部：标题 + 月份导航（上月/下月）+ 关闭按钮
- 主体：左右两栏（或上下两段，视空间自适应）
  - 左：日历网格
  - 右：选中日期的完成列表

### 4.3 交互细节

- 打开：点击按钮显示面板，并默认选中“今天”
- 关闭：
  - 点击右上角关闭按钮
  - 点击遮罩层关闭
  - 按 `Esc` 关闭（可选）
- 日期点击：
  - 选中态明显（高亮边框/背景）
  - 如果点击的是“本月外日期”（上/下月补位），v1 可直接切换月份并选中该日期（可选）

## 5. 数据与口径

### 5.1 默认口径：按完成日

- 完成日 = 将 `completedAt`（时间戳）转换为本地日期字符串 `YYYY-MM-DD`
- 只统计 `completed === true` 且 `completedAt` 有值的任务

### 5.2 时间/时区注意事项

- `completedAt` 为时间戳，转日期时应使用**本地时区**（避免 UTC 跨日）
- `dueDate` 为 `input[type="date"]` 产生的 `YYYY-MM-DD`（天然本地日期语义）

## 6. 技术方案（v1）

### 6.1 代码落点

- 主要在 `js/memo.js`：
  - 工具栏新增按钮与事件绑定
  - 新增 `showCalendarPanel()` / `renderCalendarPanel()` / `bindCalendarPanelEvents()`
  - 新增日期工具函数：`formatDateLocalYMD(ts)`（或等价）
  - 补齐完成状态切换时 `completedAt` 的写入（涉及多处 toggle）
- 样式在 `css/style.css`：
  - 新增 `.calendar-panel` 相关样式（复用 `.stats-panel` 的视觉语言）

### 6.2 数据聚合建议

- 构建 `Map<string, Task[]>`：
  - key：`YYYY-MM-DD`
  - value：该日完成任务数组（按 `completedAt` 倒序）
- 用于：
  - 日历格子 badge
  - 日期详情列表渲染

## 7. 验收标准（Acceptance Criteria）

- 工具栏新增“日历”按钮，点击后能稳定打开面板
- 日历面板能正确显示当前月份，并可切换上/下月
- 对于有完成任务的日期，格子显示完成数 badge
- 点击某日期能显示当天完成任务列表；无任务时显示空态
- 任务切换完成状态后，日历面板数据能随之更新（重新打开或实时刷新均可）
- 不影响现有“统计/番茄钟/分类管理”等功能

## 8. 后续演进（v1.8+ 方向）

- 热力图（完成数/能量值）
- 连续完成天数（streak）
- 计划 vs 实际（dueDate vs completedAt）
- 周/月复盘摘要自动生成（可导出 Markdown）

