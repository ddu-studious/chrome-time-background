<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡ç»Ÿè®¡ä»ªè¡¨ç›˜ - å¯è§†åŒ–åˆ†æ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 40px 20px;
            color: #fff;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 40px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }
        
        .stat-card.total::before { background: #64b4ff; }
        .stat-card.completed::before { background: #5cd85c; }
        .stat-card.pending::before { background: #ffc857; }
        .stat-card.overdue::before { background: #ff6b6b; }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 16px;
        }
        
        .stat-card.total .stat-icon { background: rgba(100, 180, 255, 0.2); color: #64b4ff; }
        .stat-card.completed .stat-icon { background: rgba(92, 216, 92, 0.2); color: #5cd85c; }
        .stat-card.pending .stat-icon { background: rgba(255, 200, 87, 0.2); color: #ffc857; }
        .stat-card.overdue .stat-icon { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
        
        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .stat-change {
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .stat-change.up { color: #5cd85c; }
        .stat-change.down { color: #ff6b6b; }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-title i {
            color: #64b4ff;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
        }
        
        .recent-tasks {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .recent-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .recent-title i {
            color: #5cd85c;
        }
        
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .task-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .task-status.completed { background: #5cd85c; }
        .task-status.pending { background: #ffc857; }
        .task-status.overdue { background: #ff6b6b; }
        
        .task-info {
            flex: 1;
        }
        
        .task-title {
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .task-meta {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .task-date {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.4);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.4);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .date-range {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            justify-content: center;
        }
        
        .date-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }
        
        .date-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .date-btn.active {
            background: rgba(100, 180, 255, 0.3);
            color: #64b4ff;
        }
        
        .productivity-score {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, rgba(100, 180, 255, 0.2), rgba(92, 216, 92, 0.2));
            border-radius: 16px;
            margin-bottom: 30px;
        }
        
        .score-value {
            font-size: 72px;
            font-weight: 700;
            background: linear-gradient(135deg, #64b4ff, #5cd85c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .score-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 8px;
        }
        
        .score-desc {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-chart-line"></i> ä»»åŠ¡ç»Ÿè®¡ä»ªè¡¨ç›˜</h1>
        <p class="subtitle">å¯è§†åŒ–ä½ çš„ä»»åŠ¡å®Œæˆæƒ…å†µå’Œç”Ÿäº§åŠ›è¶‹åŠ¿</p>
        
        <!-- æ—¥æœŸèŒƒå›´é€‰æ‹© -->
        <div class="date-range">
            <button class="date-btn" data-range="7">è¿‘ 7 å¤©</button>
            <button class="date-btn active" data-range="30">è¿‘ 30 å¤©</button>
            <button class="date-btn" data-range="90">è¿‘ 90 å¤©</button>
            <button class="date-btn" data-range="all">å…¨éƒ¨</button>
        </div>
        
        <!-- ç”Ÿäº§åŠ›è¯„åˆ† -->
        <div class="productivity-score">
            <div class="score-value" id="productivity-score">--</div>
            <div class="score-label">ç”Ÿäº§åŠ›è¯„åˆ†</div>
            <div class="score-desc" id="score-desc">æ­£åœ¨è®¡ç®—...</div>
        </div>
        
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-icon"><i class="fas fa-tasks"></i></div>
                <div class="stat-value" id="stat-total">0</div>
                <div class="stat-label">æ€»ä»»åŠ¡æ•°</div>
            </div>
            <div class="stat-card completed">
                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                <div class="stat-value" id="stat-completed">0</div>
                <div class="stat-label">å·²å®Œæˆ</div>
                <div class="stat-change up" id="completion-rate">
                    <i class="fas fa-arrow-up"></i> å®Œæˆç‡ --%
                </div>
            </div>
            <div class="stat-card pending">
                <div class="stat-icon"><i class="fas fa-hourglass-half"></i></div>
                <div class="stat-value" id="stat-pending">0</div>
                <div class="stat-label">å¾…å®Œæˆ</div>
            </div>
            <div class="stat-card overdue">
                <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="stat-value" id="stat-overdue">0</div>
                <div class="stat-label">å·²è¿‡æœŸ</div>
            </div>
        </div>
        
        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title">
                    <i class="fas fa-chart-bar"></i>
                    æ¯æ—¥ä»»åŠ¡å®Œæˆè¶‹åŠ¿
                </div>
                <div class="chart-container">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">
                    <i class="fas fa-chart-pie"></i>
                    ä»»åŠ¡çŠ¶æ€åˆ†å¸ƒ
                </div>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">
                    <i class="fas fa-chart-line"></i>
                    ä¼˜å…ˆçº§åˆ†å¸ƒ
                </div>
                <div class="chart-container">
                    <canvas id="priorityChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="chart-title">
                    <i class="fas fa-folder"></i>
                    åˆ†ç±»åˆ†å¸ƒ
                </div>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- æœ€è¿‘å®Œæˆçš„ä»»åŠ¡ -->
        <div class="recent-tasks">
            <div class="recent-title">
                <i class="fas fa-history"></i>
                æœ€è¿‘å®Œæˆçš„ä»»åŠ¡
            </div>
            <div class="task-list" id="recent-task-list">
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>æš‚æ— å®Œæˆçš„ä»»åŠ¡</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ä»»åŠ¡ç»Ÿè®¡ä»ªè¡¨ç›˜
        class TaskStatistics {
            constructor() {
                this.data = { memos: [], categories: [] };
                this.dateRange = 30;
                this.charts = {};
                
                this.initElements();
                this.bindEvents();
                this.loadData();
            }
            
            initElements() {
                this.statTotal = document.getElementById('stat-total');
                this.statCompleted = document.getElementById('stat-completed');
                this.statPending = document.getElementById('stat-pending');
                this.statOverdue = document.getElementById('stat-overdue');
                this.completionRate = document.getElementById('completion-rate');
                this.productivityScore = document.getElementById('productivity-score');
                this.scoreDesc = document.getElementById('score-desc');
                this.recentTaskList = document.getElementById('recent-task-list');
            }
            
            bindEvents() {
                document.querySelectorAll('.date-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.dateRange = btn.dataset.range === 'all' ? 9999 : parseInt(btn.dataset.range);
                        this.updateStats();
                        this.updateCharts();
                    });
                });
            }
            
            async loadData() {
                try {
                    const result = await new Promise(resolve => {
                        if (typeof chrome !== 'undefined' && chrome.storage) {
                            chrome.storage.local.get(['memos', 'memosCategories'], resolve);
                        } else {
                            // æ¼”ç¤ºæ•°æ®
                            const demoMemos = this.generateDemoData();
                            resolve({
                                memos: demoMemos,
                                memosCategories: [
                                    { id: '1', name: 'å·¥ä½œ', color: '#ff6b6b' },
                                    { id: '2', name: 'å­¦ä¹ ', color: '#64b4ff' },
                                    { id: '3', name: 'ç”Ÿæ´»', color: '#5cd85c' }
                                ]
                            });
                        }
                    });
                    
                    this.data.memos = result.memos || [];
                    this.data.categories = result.memosCategories || [];
                    
                    this.updateStats();
                    this.initCharts();
                    this.updateRecentTasks();
                } catch (error) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                }
            }
            
            generateDemoData() {
                const memos = [];
                const priorities = ['high', 'medium', 'low', 'none'];
                const categoryIds = ['1', '2', '3', null];
                
                for (let i = 0; i < 50; i++) {
                    const daysAgo = Math.floor(Math.random() * 60);
                    const date = new Date();
                    date.setDate(date.getDate() - daysAgo);
                    
                    const completed = Math.random() > 0.3;
                    const isOverdue = !completed && Math.random() > 0.7;
                    
                    let dueDate = new Date();
                    if (isOverdue) {
                        dueDate.setDate(dueDate.getDate() - Math.floor(Math.random() * 10));
                    } else {
                        dueDate.setDate(dueDate.getDate() + Math.floor(Math.random() * 30));
                    }
                    
                    memos.push({
                        id: String(i + 1),
                        title: `ç¤ºä¾‹ä»»åŠ¡ ${i + 1}`,
                        completed: completed,
                        createdAt: date.getTime(),
                        updatedAt: completed ? (date.getTime() + Math.random() * 86400000 * 3) : date.getTime(),
                        priority: priorities[Math.floor(Math.random() * priorities.length)],
                        categoryId: categoryIds[Math.floor(Math.random() * categoryIds.length)],
                        dueDate: dueDate.toISOString().split('T')[0]
                    });
                }
                
                return memos;
            }
            
            getFilteredMemos() {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - this.dateRange);
                
                return this.data.memos.filter(memo => {
                    const memoDate = new Date(memo.createdAt);
                    return memoDate >= cutoffDate;
                });
            }
            
            updateStats() {
                const memos = this.getFilteredMemos();
                const today = new Date().toISOString().split('T')[0];
                
                const total = memos.length;
                const completed = memos.filter(m => m.completed).length;
                const pending = total - completed;
                const overdue = memos.filter(m => !m.completed && m.dueDate && m.dueDate < today).length;
                
                this.statTotal.textContent = total;
                this.statCompleted.textContent = completed;
                this.statPending.textContent = pending;
                this.statOverdue.textContent = overdue;
                
                const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
                this.completionRate.innerHTML = `<i class="fas fa-arrow-${rate >= 50 ? 'up' : 'down'}"></i> å®Œæˆç‡ ${rate}%`;
                this.completionRate.className = `stat-change ${rate >= 50 ? 'up' : 'down'}`;
                
                // è®¡ç®—ç”Ÿäº§åŠ›è¯„åˆ†
                this.calculateProductivityScore(total, completed, overdue);
            }
            
            calculateProductivityScore(total, completed, overdue) {
                if (total === 0) {
                    this.productivityScore.textContent = '--';
                    this.scoreDesc.textContent = 'æš‚æ— ä»»åŠ¡æ•°æ®';
                    return;
                }
                
                // è¯„åˆ†ç®—æ³•ï¼šå®Œæˆç‡ * 0.7 + (1 - è¿‡æœŸç‡) * 0.3
                const completionRate = completed / total;
                const overdueRate = overdue / total;
                const score = Math.round((completionRate * 0.7 + (1 - overdueRate) * 0.3) * 100);
                
                this.productivityScore.textContent = score;
                
                let desc;
                if (score >= 90) desc = 'å¤ªæ£’äº†ï¼ä½ çš„ç”Ÿäº§åŠ›éå¸¸é«˜ï¼ğŸŒŸ';
                else if (score >= 70) desc = 'åšå¾—ä¸é”™ï¼Œç»§ç»­ä¿æŒï¼ğŸ’ª';
                else if (score >= 50) desc = 'è¿˜æœ‰æå‡ç©ºé—´ï¼ŒåŠ æ²¹ï¼ğŸ¯';
                else desc = 'éœ€è¦æ”¹è¿›ä»»åŠ¡ç®¡ç†ç­–ç•¥ ğŸ“';
                
                this.scoreDesc.textContent = desc;
            }
            
            initCharts() {
                Chart.defaults.color = 'rgba(255, 255, 255, 0.7)';
                Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
                
                this.initDailyChart();
                this.initStatusChart();
                this.initPriorityChart();
                this.initCategoryChart();
            }
            
            initDailyChart() {
                const ctx = document.getElementById('dailyChart').getContext('2d');
                const { labels, completed, created } = this.getDailyData();
                
                this.charts.daily = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'å®Œæˆ',
                                data: completed,
                                backgroundColor: 'rgba(92, 216, 92, 0.6)',
                                borderRadius: 4
                            },
                            {
                                label: 'åˆ›å»º',
                                data: created,
                                backgroundColor: 'rgba(100, 180, 255, 0.6)',
                                borderRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            getDailyData() {
                const days = Math.min(this.dateRange, 14);
                const labels = [];
                const completed = [];
                const created = [];
                
                for (let i = days - 1; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    labels.push(date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }));
                    
                    const dayMemos = this.data.memos.filter(m => {
                        const memoDate = new Date(m.createdAt).toISOString().split('T')[0];
                        return memoDate === dateStr;
                    });
                    
                    const dayCompleted = this.data.memos.filter(m => {
                        if (!m.completed || !m.updatedAt) return false;
                        const updateDate = new Date(m.updatedAt).toISOString().split('T')[0];
                        return updateDate === dateStr;
                    });
                    
                    created.push(dayMemos.length);
                    completed.push(dayCompleted.length);
                }
                
                return { labels, completed, created };
            }
            
            initStatusChart() {
                const ctx = document.getElementById('statusChart').getContext('2d');
                const memos = this.getFilteredMemos();
                const today = new Date().toISOString().split('T')[0];
                
                const completed = memos.filter(m => m.completed).length;
                const pending = memos.filter(m => !m.completed && (!m.dueDate || m.dueDate >= today)).length;
                const overdue = memos.filter(m => !m.completed && m.dueDate && m.dueDate < today).length;
                
                this.charts.status = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['å·²å®Œæˆ', 'å¾…å®Œæˆ', 'å·²è¿‡æœŸ'],
                        datasets: [{
                            data: [completed, pending, overdue],
                            backgroundColor: [
                                'rgba(92, 216, 92, 0.8)',
                                'rgba(255, 200, 87, 0.8)',
                                'rgba(255, 107, 107, 0.8)'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right' }
                        }
                    }
                });
            }
            
            initPriorityChart() {
                const ctx = document.getElementById('priorityChart').getContext('2d');
                const memos = this.getFilteredMemos();
                
                const priorities = {
                    high: memos.filter(m => m.priority === 'high').length,
                    medium: memos.filter(m => m.priority === 'medium').length,
                    low: memos.filter(m => m.priority === 'low').length,
                    none: memos.filter(m => !m.priority || m.priority === 'none').length
                };
                
                this.charts.priority = new Chart(ctx, {
                    type: 'polarArea',
                    data: {
                        labels: ['é«˜ä¼˜å…ˆçº§', 'ä¸­ä¼˜å…ˆçº§', 'ä½ä¼˜å…ˆçº§', 'æ— ä¼˜å…ˆçº§'],
                        datasets: [{
                            data: [priorities.high, priorities.medium, priorities.low, priorities.none],
                            backgroundColor: [
                                'rgba(255, 107, 107, 0.7)',
                                'rgba(255, 200, 87, 0.7)',
                                'rgba(92, 216, 92, 0.7)',
                                'rgba(150, 150, 150, 0.7)'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right' }
                        }
                    }
                });
            }
            
            initCategoryChart() {
                const ctx = document.getElementById('categoryChart').getContext('2d');
                const memos = this.getFilteredMemos();
                
                const categoryData = {};
                this.data.categories.forEach(cat => {
                    categoryData[cat.id] = { name: cat.name, count: 0 };
                });
                categoryData['none'] = { name: 'æœªåˆ†ç±»', count: 0 };
                
                memos.forEach(memo => {
                    const catId = memo.categoryId || 'none';
                    if (categoryData[catId]) {
                        categoryData[catId].count++;
                    } else {
                        categoryData['none'].count++;
                    }
                });
                
                const labels = Object.values(categoryData).map(c => c.name);
                const data = Object.values(categoryData).map(c => c.count);
                
                const colors = [
                    'rgba(255, 107, 107, 0.7)',
                    'rgba(100, 180, 255, 0.7)',
                    'rgba(92, 216, 92, 0.7)',
                    'rgba(180, 140, 255, 0.7)',
                    'rgba(255, 200, 87, 0.7)',
                    'rgba(150, 150, 150, 0.7)'
                ];
                
                this.charts.category = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right' }
                        }
                    }
                });
            }
            
            updateCharts() {
                // æ›´æ–°æ‰€æœ‰å›¾è¡¨
                Object.values(this.charts).forEach(chart => chart.destroy());
                this.initCharts();
            }
            
            updateRecentTasks() {
                const completedTasks = this.data.memos
                    .filter(m => m.completed)
                    .sort((a, b) => (b.updatedAt || b.createdAt) - (a.updatedAt || a.createdAt))
                    .slice(0, 5);
                
                if (completedTasks.length === 0) {
                    this.recentTaskList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>æš‚æ— å®Œæˆçš„ä»»åŠ¡</p>
                        </div>
                    `;
                    return;
                }
                
                this.recentTaskList.innerHTML = completedTasks.map(task => {
                    const date = new Date(task.updatedAt || task.createdAt);
                    const dateStr = date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    
                    return `
                        <div class="task-item">
                            <div class="task-status completed"></div>
                            <div class="task-info">
                                <div class="task-title">${task.title}</div>
                                <div class="task-meta">å®Œæˆäº ${dateStr}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        // åˆå§‹åŒ–
        const stats = new TaskStatistics();
    </script>
</body>
</html>
